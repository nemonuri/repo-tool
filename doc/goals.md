# Goals

## 1. `GenerateFStarConfigJson` MSBuild Task

### Usage senario

1. Assume
    - **Bob** wants to write F* project, with vscode and F* assistance.
    - Bob installed `F* release` under **/My/Secretes/** directory.
    - Bob made git repository under **/My/FStarProj/RepoRoot/** , and writes **.fst.config.json**
    - '.fst.config.json' contains raw text of '/My/Secretes/' path, and Bob does not want to expose it to public. (1)
    - '.fst.config.json' contains lots of important options, and Bob wants to git keeps track of that options. (2)
    - (1) and (2) are contradiction, because Bob cannot split '.fst.config.json' file.
    - Bob wants to solve this problem, by detouring ㅡ use MSBuild.

2. Bob creates **Tool.proj** and apply [Microsoft.Build.NoTargets](https://github.com/microsoft/MSBuildSdks/tree/main/src/NoTargets) SDK.

3. Bob writes '/My/Secretes/' path in **Private.props** a sub directory of '/My/FStarProj/RepoRoot/', and lets git ignores it.

4. Bob modifies Tool.proj to import Private.props

5. Bob makes default MSBuild target as **Invoke** in Tool.proj, that runs **GenerateFStarConfigJson** Task.

6. Bob invokes command `dotnet msbuild`
    1. 'sdk.g.fst.config.json' file is created. It contains information text like 'Auto Generated by Tool.proj. Do not Edit.'
    2. 'sdk.g.fst.config.json' line is added to '.gitignore'

7. Done!

### Test senario

1. Assume Input
    - Kind of 'fstar.exe'
      - **directory.fstar.exe** is directory.
      - **not-exist.fstar.exe** is not exist.
      - **txt.fstar.exe** is text file.
      - **return1.fstar.exe** just returns 1.
      - **return0.fstar.exe** just returns 0.
      - **stderr-version.fstar.exe** messages valid version to stderr, and returns 0.
      - **stdout1-version.fstar.exe** messages valid version to stdout, and returns 1.
      - **stdout0-version.fstar.exe** messages valid version to stdout, and returns 0.
      - **stdin.fstar.exe** waits until stdin(ReadKey), messages valid version to stdout, and returns 0.
      - **stdin_readline.fstar.exe** waits until stdin(ReadLine), messages valid version to stdout, and returns 0.
      - **sleep1s-stdout0-version.fstar.exe** sleeps 1 second, and messages valid version to stdout, and returns 0.
      - **sleep10s-stdout0-version.fstar.exe** sleeps 10 second, and messages valid version to stdout, and returns 0.
    - Mock MSBuild engine, which executes 'GenerateFStarConfigJson' task


2. Assume Output
    - **TaskSuccess** is success(true) or failure(false) of 'GenerateFStarConfigJson' task

3. Expected Result

| fstar.exe | TaskSuccess | *note*
| --- | --- | --- |
| directory.fstar | false ||
| not-exist.fstar | false ||
| txt.fstar | false ||
| return1.fstar | false ||
| return0.fstar | false ||
| stderr-version.fstar | false ||
| stdout1-version.fstar | true | Exitcode will be ignored. |
| stdout0-version.fstar | true ||
| stdin.fstar | false ||
| stdin_readline.fstar | false ||
| sleep1s-stdout0-version.fstar | true ||
| sleep10s-stdout0-version.fstar | false ||


### Deploy senario

(TODO)

## 2. `EditGeneratedFStarConfigJson` MSBuild Task

- Automate editing '.fst.config.json'
  - Restricted to auto-generated. (by 'GenerateFStarConfigJson')
  - Do not edit manual config.

### Usage senario

1. Assume
    - A data type **FStarConfigJsonModel** exist.
    - A MSBuild target **Trigger** exist, which contains 'EditGeneratedFStarConfigJson' task.
    - Kinds of **F\* Toolset Directory Layout** (a.k.a. 'F\* Layout') exist.
        1. Unknown
        2. GithubRelease
        3. NuGetPackage
    - For each 'F\* Layout', resolve and create 'FStarConfigJsonModel' method exists.
    - An immutable string **F\* Config File Path** (a.k.a. 'Cfg Path') exist. 
    - 'EditGeneratedFStarConfigJson' can get 'Cfg Path'.
    - 'The task' is alias of 'EditGeneratedFStarConfigJson'

2. **Bob** writes main fstar bin path to 'FStarExePath', and invoke 'Trigger'. 'EditGeneratedFStarConfigJson' task begins.

3. First, 'the task' checks that auto-generated F\* config file exists at 'Cfg Path'.
    - If not, throw error.

4. 'The task' get **F\* exe** path from 'Cfg Path'

5. 'The task' assume 'F\* Layout' is 'GithubRelease', and resolve.
    1. If failed, repeat. (NuGetPackage → Unknown order)
    2. If failed, throw error.

6. 'The task' crates 'FStarConfigJsonModel' instance, and normalize it.
    1. If failed, throw error.

7. 'The task' serializes 'FStarConfigJsonModel' instance to string, and edit file of 'Cfg Path'.

8. Done!

### Test senario

1. Assume Input
    - Kind of 'F\* Layout'
        - (...)
    - Kind of 'Cfg Path'
        - (...)

### Note

- How can 'EditGeneratedFStarConfigJson' task get 'Cfg Path'?
  - Use [MSBuildProjectExtensionsPath](https://learn.microsoft.com/en-us/nuget/reference/msbuild-targets#restore-properties), like NuGet!
    - per project
  - Or, [IntermediateOutputPath](https://learn.microsoft.com/en-us/visualstudio/msbuild/common-msbuild-project-properties)
    - per (project, configuration, tfm, rid)
